<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prediction Analytics - Bank Nifty Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        h1 {
            color: #333;
            font-size: 2em;
            margin-bottom: 10px;
        }

        .nav-links {
            margin-top: 15px;
        }

        .nav-links a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            margin-right: 20px;
            transition: color 0.3s;
        }

        .nav-links a:hover {
            color: #764ba2;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .stat-card h3 {
            color: #6b7280;
            font-size: 0.9em;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-subtitle {
            color: #9ca3af;
            font-size: 0.85em;
        }

        .section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .threshold-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .threshold-input {
            padding: 10px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1em;
            width: 150px;
        }

        .threshold-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        tbody tr {
            border-bottom: 1px solid #e5e7eb;
            transition: background 0.2s;
        }

        tbody tr:hover {
            background: #f9fafb;
        }

        td {
            padding: 12px 15px;
        }

        .success {
            background: #d1fae5;
            color: #065f46;
            font-weight: bold;
        }

        .fail {
            background: #fee2e2;
            color: #991b1b;
            font-weight: bold;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .badge-success {
            background: #10b981;
            color: white;
        }

        .badge-fail {
            background: #ef4444;
            color: white;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: white;
            font-size: 1.5em;
        }

        .chart-container {
            margin-top: 20px;
            padding: 20px;
            background: #f9fafb;
            border-radius: 10px;
            overflow-x: auto;
        }

        .timeline-item {
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #e5e7eb;
            background: #f9fafb;
            border-radius: 5px;
            transition: all 0.3s;
        }

        .timeline-item:hover {
            border-left-color: #667eea;
            background: #f3f4f6;
        }

        .timeline-item.hit {
            border-left-color: #10b981;
        }

        .timeline-item.miss {
            border-left-color: #ef4444;
        }

        .filter-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-tab {
            padding: 8px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .filter-tab:hover {
            border-color: #667eea;
        }

        .filter-tab.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e5e7eb;
            border-radius: 15px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä Prediction Analytics</h1>
            <p style="color: #6b7280; margin-top: 5px;">Analyzing how well your calculated total predicts Bank Nifty Index</p>
            <div class="nav-links">
                <a href="/">‚Üê Back to Tracker</a>
            </div>
        </header>

        <div id="loadingContainer" class="loading">Loading analytics data...</div>

        <div id="analyticsContainer" style="display: none;">
            <!-- Summary Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Data Points</h3>
                    <div class="stat-value" id="totalPoints">0</div>
                    <div class="stat-subtitle">Collected observations</div>
                </div>

                <div class="stat-card">
                    <h3>Success Rate</h3>
                    <div class="stat-value" style="color: #10b981;" id="successRate">0%</div>
                    <div class="stat-subtitle">Predictions within threshold</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="successProgress" style="width: 0%;">0%</div>
                    </div>
                </div>

                <div class="stat-card">
                    <h3>Correlation</h3>
                    <div class="stat-value" style="color: #667eea;" id="correlation">0.0000</div>
                    <div class="stat-subtitle">1.0 = perfect match</div>
                </div>

                <div class="stat-card">
                    <h3>Avg Difference</h3>
                    <div class="stat-value" style="color: #f59e0b;" id="avgDiff">0%</div>
                    <div class="stat-subtitle">Mean percentage error</div>
                </div>
            </div>

            <!-- Threshold Configuration -->
            <div class="section">
                <h2>‚öôÔ∏è Target Threshold</h2>
                <p style="color: #6b7280; margin-bottom: 15px;">
                    Set the acceptable difference percentage to determine when your prediction "hits" the target
                </p>
                <div class="threshold-controls">
                    <label style="font-weight: 600;">Threshold:</label>
                    <input type="number" id="thresholdInput" class="threshold-input" value="0.5" step="0.1" min="0.1" max="10">
                    <span style="font-weight: 600;">%</span>
                    <button class="btn" onclick="applyThreshold()">Apply</button>
                    <span style="color: #6b7280; margin-left: 10px;" id="thresholdHelp">
                        Prediction is "hit" if difference ‚â§ 0.5%
                    </span>
                </div>
            </div>

            <!-- Hit/Miss Analysis -->
            <div class="section">
                <h2>üéØ Target Analysis</h2>
                <div class="stats-grid" style="margin-bottom: 20px;">
                    <div class="stat-card" style="border-left: 4px solid #10b981;">
                        <h3>Targets Hit</h3>
                        <div class="stat-value" style="color: #10b981;" id="hitsCount">0</div>
                        <div class="stat-subtitle" id="hitTimes">0 times</div>
                    </div>

                    <div class="stat-card" style="border-left: 4px solid #ef4444;">
                        <h3>Targets Missed</h3>
                        <div class="stat-value" style="color: #ef4444;" id="missCount">0</div>
                        <div class="stat-subtitle" id="missTimes">0 times</div>
                    </div>

                    <div class="stat-card" style="border-left: 4px solid #667eea;">
                        <h3>Best Prediction</h3>
                        <div class="stat-value" style="color: #667eea; font-size: 1.8em;" id="bestPrediction">0%</div>
                        <div class="stat-subtitle" id="bestPredictionTime">-</div>
                    </div>

                    <div class="stat-card" style="border-left: 4px solid #f59e0b;">
                        <h3>Worst Prediction</h3>
                        <div class="stat-value" style="color: #f59e0b; font-size: 1.8em;" id="worstPrediction">0%</div>
                        <div class="stat-subtitle" id="worstPredictionTime">-</div>
                    </div>
                </div>
            </div>

            <!-- Filter Tabs -->
            <div class="section">
                <h2>üìÖ Timeline</h2>
                <div class="filter-tabs">
                    <div class="filter-tab active" onclick="filterTimeline('all')">All</div>
                    <div class="filter-tab" onclick="filterTimeline('hits')">Hits Only</div>
                    <div class="filter-tab" onclick="filterTimeline('misses')">Misses Only</div>
                    <div class="filter-tab" onclick="filterTimeline('today')">Today</div>
                </div>

                <div id="timelineContainer" style="max-height: 600px; overflow-y: auto;">
                    <!-- Timeline items will be inserted here -->
                </div>
            </div>

            <!-- Detailed Data Table -->
            <div class="section">
                <h2>üìã Detailed Log</h2>
                <div style="max-height: 500px; overflow-y: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Date & Time</th>
                                <th>Bank Nifty</th>
                                <th>Your Total</th>
                                <th>Difference</th>
                                <th>% Diff</th>
                                <th>Result</th>
                            </tr>
                        </thead>
                        <tbody id="detailedTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let historicalData = [];
        let threshold = 0.5; // Default 0.5% threshold
        let currentFilter = 'all';

        // Get API base URL
        const API_BASE = window.location.hostname === 'localhost'
            ? 'http://localhost:3000'
            : '';

        // Fetch data on load
        async function fetchAnalyticsData() {
            try {
                const response = await fetch(`${API_BASE}/api/historical`);
                const result = await response.json();

                if (result.success && result.data.length > 0) {
                    historicalData = result.data;
                    renderAnalytics();
                    document.getElementById('loadingContainer').style.display = 'none';
                    document.getElementById('analyticsContainer').style.display = 'block';
                } else {
                    document.getElementById('loadingContainer').innerHTML = `
                        <div style="background: white; padding: 30px; border-radius: 15px; color: #6b7280;">
                            <h2 style="color: #333; margin-bottom: 15px;">No Data Available Yet</h2>
                            <p>Historical data will appear here once the server starts logging during market hours.</p>
                            <p style="margin-top: 10px;">The system logs data every 5 minutes from 9:15 AM to 3:30 PM IST.</p>
                            <a href="/" style="display: inline-block; margin-top: 20px; color: #667eea; text-decoration: none; font-weight: 600;">‚Üê Back to Tracker</a>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error fetching analytics:', error);
                document.getElementById('loadingContainer').innerHTML = `
                    <div style="background: white; padding: 30px; border-radius: 15px; color: #ef4444;">
                        <h2 style="color: #333; margin-bottom: 15px;">Error Loading Data</h2>
                        <p>${error.message}</p>
                        <a href="/" style="display: inline-block; margin-top: 20px; color: #667eea; text-decoration: none; font-weight: 600;">‚Üê Back to Tracker</a>
                    </div>
                `;
            }
        }

        function renderAnalytics() {
            const data = historicalData;

            // Calculate hits and misses
            const hits = data.filter(d => Math.abs(parseFloat(d.percentageDiff)) <= threshold);
            const misses = data.filter(d => Math.abs(parseFloat(d.percentageDiff)) > threshold);
            const successRate = (hits.length / data.length * 100).toFixed(2);

            // Find best and worst predictions
            const sortedByDiff = [...data].sort((a, b) =>
                Math.abs(parseFloat(a.percentageDiff)) - Math.abs(parseFloat(b.percentageDiff))
            );
            const best = sortedByDiff[0];
            const worst = sortedByDiff[sortedByDiff.length - 1];

            // Calculate average difference
            const avgDiff = (data.reduce((sum, d) => sum + Math.abs(parseFloat(d.percentageDiff)), 0) / data.length).toFixed(4);

            // Calculate correlation
            const bankNiftyValues = data.map(d => d.bankNiftyIndex);
            const calculatedValues = data.map(d => d.calculatedTotal);
            const correlation = calculateCorrelation(bankNiftyValues, calculatedValues);

            // Update stats
            document.getElementById('totalPoints').textContent = data.length;
            document.getElementById('successRate').textContent = successRate + '%';
            document.getElementById('successProgress').style.width = successRate + '%';
            document.getElementById('successProgress').textContent = successRate + '%';
            document.getElementById('correlation').textContent = correlation;
            document.getElementById('avgDiff').textContent = avgDiff + '%';

            document.getElementById('hitsCount').textContent = hits.length;
            document.getElementById('hitTimes').textContent = `${hits.length} times`;
            document.getElementById('missCount').textContent = misses.length;
            document.getElementById('missTimes').textContent = `${misses.length} times`;

            if (best) {
                document.getElementById('bestPrediction').textContent = Math.abs(parseFloat(best.percentageDiff)).toFixed(4) + '%';
                document.getElementById('bestPredictionTime').textContent = formatDateTime(best.timestamp);
            }

            if (worst) {
                document.getElementById('worstPrediction').textContent = Math.abs(parseFloat(worst.percentageDiff)).toFixed(4) + '%';
                document.getElementById('worstPredictionTime').textContent = formatDateTime(worst.timestamp);
            }

            // Render timeline and table
            renderTimeline();
            renderDetailedTable();
        }

        function renderTimeline() {
            const container = document.getElementById('timelineContainer');
            let filteredData = [...historicalData].reverse();

            // Apply filters
            if (currentFilter === 'hits') {
                filteredData = filteredData.filter(d => Math.abs(parseFloat(d.percentageDiff)) <= threshold);
            } else if (currentFilter === 'misses') {
                filteredData = filteredData.filter(d => Math.abs(parseFloat(d.percentageDiff)) > threshold);
            } else if (currentFilter === 'today') {
                const today = new Date().toDateString();
                filteredData = filteredData.filter(d => new Date(d.timestamp).toDateString() === today);
            }

            container.innerHTML = filteredData.map(point => {
                const isHit = Math.abs(parseFloat(point.percentageDiff)) <= threshold;
                const hitClass = isHit ? 'hit' : 'miss';
                const badge = isHit ? 'badge-success' : 'badge-fail';
                const badgeText = isHit ? '‚úì HIT' : '‚úó MISS';

                return `
                    <div class="timeline-item ${hitClass}">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                            <div>
                                <div style="font-weight: 600; color: #1f2937; margin-bottom: 5px;">
                                    ${formatDateTime(point.timestamp)}
                                </div>
                                <div style="font-size: 0.9em; color: #6b7280;">
                                    Bank Nifty: <strong>‚Çπ${point.bankNiftyIndex.toFixed(2)}</strong>
                                    | Your Total: <strong>‚Çπ${point.calculatedTotal.toFixed(2)}</strong>
                                    | Diff: <strong style="color: ${parseFloat(point.percentageDiff) >= 0 ? '#10b981' : '#ef4444'};">${point.percentageDiff}%</strong>
                                </div>
                            </div>
                            <span class="badge ${badge}">${badgeText}</span>
                        </div>
                    </div>
                `;
            }).join('');

            if (filteredData.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;">No data points match the current filter</div>';
            }
        }

        function renderDetailedTable() {
            const tbody = document.getElementById('detailedTableBody');
            const data = [...historicalData].reverse();

            tbody.innerHTML = data.map(point => {
                const isHit = Math.abs(parseFloat(point.percentageDiff)) <= threshold;
                const resultClass = isHit ? 'success' : 'fail';
                const resultText = isHit ? '‚úì HIT' : '‚úó MISS';
                const diffColor = parseFloat(point.percentageDiff) >= 0 ? '#10b981' : '#ef4444';

                return `
                    <tr>
                        <td>${formatDateTime(point.timestamp)}</td>
                        <td style="font-weight: 600;">‚Çπ${point.bankNiftyIndex.toFixed(2)}</td>
                        <td style="font-weight: 600;">‚Çπ${point.calculatedTotal.toFixed(2)}</td>
                        <td style="font-weight: 600; color: ${diffColor};">‚Çπ${point.difference.toFixed(2)}</td>
                        <td style="font-weight: bold; color: ${diffColor};">${point.percentageDiff}%</td>
                        <td class="${resultClass}">${resultText}</td>
                    </tr>
                `;
            }).join('');
        }

        function applyThreshold() {
            const input = document.getElementById('thresholdInput');
            threshold = parseFloat(input.value) || 0.5;
            document.getElementById('thresholdHelp').textContent =
                `Prediction is "hit" if difference ‚â§ ${threshold}%`;
            renderAnalytics();
        }

        function filterTimeline(filter) {
            currentFilter = filter;

            // Update active tab
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            renderTimeline();
        }

        function formatDateTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString('en-IN', {
                timeZone: 'Asia/Kolkata',
                dateStyle: 'medium',
                timeStyle: 'short'
            });
        }

        function calculateCorrelation(x, y) {
            const n = x.length;
            if (n < 2) return '0.0000';

            const meanX = x.reduce((a, b) => a + b, 0) / n;
            const meanY = y.reduce((a, b) => a + b, 0) / n;

            const numerator = x.reduce((sum, xi, i) => sum + (xi - meanX) * (y[i] - meanY), 0);
            const denomX = Math.sqrt(x.reduce((sum, xi) => sum + Math.pow(xi - meanX, 2), 0));
            const denomY = Math.sqrt(y.reduce((sum, yi) => sum + Math.pow(yi - meanY, 2), 0));

            if (denomX === 0 || denomY === 0) return '0.0000';

            return (numerator / (denomX * denomY)).toFixed(4);
        }

        // Auto-refresh every 2 minutes
        setInterval(() => {
            fetchAnalyticsData();
        }, 120000);

        // Initial load
        fetchAnalyticsData();
    </script>
</body>
</html>
